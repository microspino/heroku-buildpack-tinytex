#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2
BINDIR=$(cd $(dirname $0); pwd)
# VERSION_STAMP=$BUILD_DIR/.TINYTEX-version
PLATFORM=$(uname -m)-$(uname -s | tr A-Z a-z)
TINYTEX_HOME=$BUILD_DIR/TinyTeX
# TINYTEX_CACHE=$CACHE_DIR/.TinyTeX_Cache
PATH=$TINYTEX_HOME/bin/${PLATFORM}:$PATH
# PROFILE_D=$BUILD_DIR/.profile.d/TINYTEX.sh

source $BINDIR/utils

mkdir -p $TINYTEX_HOME
# mkdir -p $TINYTEX_CACHE
# mkdir -p `dirname $PROFILE_D`

build-step "Fetching TinyTex $VERSION for $PLATFORM"

cd $TINYTEX_HOME
TINYTEX_URL="https://github.com/rstudio/tinytex-releases/releases/download/daily/installer-unix"
wget --retry-connrefused --progress=dot:giga -O TinyTeX.tar.gz ${TINYTEX_URL}.tar.gz
tar xf TinyTeX.tar.gz -C $(dirname $TINYTEX_HOME)
rm TinyTeX.tar.gz

build-step "TinyTex saved to $(dirname $TINYTEX_HOME)"

ls -alh .

cd $TINYTEX_HOME/bin
./tlmgr option sys_bin $BINDIR
./tlmgr postaction install script xetex
./tlmgr option repository ctan
./tlmgr path add

if [ ! `which pdflatex` ]; then
    build-warn "TinyTex installation failed"
    exit 1
fi

# echo "export PATH=\$TINYTEX_HOME/bin/${PLATFORM}:\$PATH" >> $PROFILE_D
