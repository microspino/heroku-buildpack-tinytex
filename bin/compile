#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2
BINDIR=$(cd $(dirname $0); pwd)
# VERSION_STAMP=$BUILD_DIR/.TINYTEX-version
PLATFORM=$(uname -m)-$(uname -s | tr A-Z a-z)
TINYTEX_HOME=$BUILD_DIR/TinyTeX
# TINYTEX_CACHE=$CACHE_DIR/.TinyTeX_Cache
PATH=$TINYTEX_HOME/bin/${PLATFORM}:$PATH
# PROFILE_D=$BUILD_DIR/.profile.d/TINYTEX.sh

source $BINDIR/utils

mkdir -p $TINYTEX_HOME

tar xf tiny-tex-installer-unix.tar.gz

build-step "TinyTex saved to $(dirname $TINYTEX_HOME)"

ls -alh .

./bin/tlmgr option sys_bin $BINDIR
./bin/tlmgr postaction install script xetex
./bin/tlmgr option repository ctan
./bin/tlmgr path add

if [ ! `which pdflatex` ]; then
    build-warn "TinyTex installation failed"
    exit 1
fi

# echo "export PATH=\$TINYTEX_HOME/bin/${PLATFORM}:\$PATH" >> $PROFILE_D
